<!DOCTYPE html>
<html>

<head>
    <script src="node_modules/phaser/dist/phaser-arcade-physics.min.js"></script>
    <title>CastleClimber Game</title>
</head>
<body>

    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1024,
            height: 768,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 480 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var levels =
            [{
                repeat: 0
            },
            {
                repeat: 1
            },
            {
                repeat: 3
            },
            {
                repeat: 7
            },
            {
                repeat: 10
            }];



        var player;
        var wm; // wash machine

        var stars;
        var platforms;
        var cursors;
        var score = 0;
        var scoreText;

        var level = 0;

        var hasStars = 0;
        var washStarted = false;

        var timer = 0;
        var timerText;

        var gameOver = false;
        var music;

        var didCollectFlag = false;

        var theGround;

        var knight1;
        var knight2;
        var knight3;

        var flagSound;
        var fallSound;
        var thudSound;
        var punchSound;

        var knight3didHitGround = false;
        var didPlayKnight3GroundSound = false;

        var knight3falling = false;
        var didPlayKnight3FallingSound = false;
        var deadKnight3;

        var knightParticleOffsetX = 30;
        var knightParticleOffsetY = 0;

        var game = new Phaser.Game(config);

        function preload() {

            this.load.audio('piano', ['assets/piano.wav']);

            this.load.audio('flagSound', ['assets/flag.wav']);
            this.load.audio('fallSound', ['assets/falling.wav']);
            this.load.audio('thudSound', ['assets/thud.wav']);
            this.load.audio('punchSound', ['assets/punch.wav']);


            this.load.image('invisible', 'assets/img/invisible.png');
            this.load.image('sky', 'assets/img/castle.png');
            this.load.image('ground', 'assets/img/ground.png');
            this.load.image('platform2', 'assets/img/platform2.png');

            this.load.image('platform-8', 'assets/img/platform-8.png');
            this.load.image('platform-7', 'assets/img/platform-7.png');
            this.load.image('platform-4', 'assets/img/platform-4.png');
            this.load.image('platform-5', 'assets/img/platform-5.png');
            this.load.image('platform-3', 'assets/img/platform-3.png');
            this.load.image('platform-1', 'assets/img/platform-1.png');

            this.load.image('star', 'assets/img/star.png');

            this.load.image('flag', 'assets/img/flag.png');

            this.load.spritesheet('knight-walk', 'assets/img/knight-remaster/knight-sprite-large.png', { frameWidth: 155.5, frameHeight: 300 });
            this.load.spritesheet('knight-idle', 'assets/img/knight-remaster/knight-sprite-idle.png', { frameWidth: 155.5, frameHeight: 300 });
            this.load.spritesheet('knight-punch', 'assets/img/knight-remaster/knight-punch-sprite.png', { frameWidth: 155.4, frameHeight: 300 });

            this.load.spritesheet('dude', 'assets/img/frog/frog-sprite.png', { frameWidth: 53, frameHeight: 48 });
            this.load.spritesheet('dude-with-king', 'assets/img/king/king-sprite.png', { frameWidth: 41, frameHeight: 58 });
            this.load.spritesheet('wash-cycle', 'assets/img/wash-cycle.png', { frameWidth: 191, frameHeight: 209 });
        
            this.load.image('deadKnight', 'assets/img/knight-remaster/knight-dead.png');
        
            this.load.atlas('flares', 'assets/particle/flares.png', 'assets/particle/flares.json');
        }

        function create() {
            //this.add.image(2440, 3432, 'sky');

            // background
            this.background = this.add.image(0, 0, "sky")
            .setOrigin(0, 0);
            // Based on your game size, it may "stretch" and distort.
            this.background.displayWidth = this.sys.canvas.width;
            this.background.displayHeight = this.sys.canvas.height;

            platforms = this.physics.add.staticGroup();

            // actual ground
            platforms.create(200, 750, 'ground').setScale(0.43).setOrigin(0.2,0.5).refreshBody().setName('ground');

            // platform 8: nearest floor
            platforms.create(650, 920, 'platform-8').setScale(0.43).setOrigin(0.5,5.9).refreshBody();

            // platform 7 left side, right hand component
            platforms.create(450, 700, 'platform-7').setScale(0.4,0.3).setOrigin(0.5,5.9).refreshBody();

            // platform 4 left side, right hand component
            platforms.create(468, 790, 'platform-4').setScale(0.4,0.3).setOrigin(0.5,5.9).refreshBody();

            // platform 5 right side
             platforms.create(700, 645, 'platform-5').setScale(0.4,0.3).setOrigin(0.5,5.9).refreshBody();

            // platform 3 right side
            platforms.create(418, 522, 'platform-3').setScale(0.4,0.3).setOrigin(0.5,5.9).refreshBody();

            // platform 1 top side
            platforms.create(620, 460, 'platform-1').setScale(0.4,0.3).setOrigin(0.5,5.9).refreshBody();

            // platform 0 turret height
            // platforms.create(630, 80, 'platform-0').setScale(8,0.2).setOrigin(0,0).refreshBody();

            flagSound = this.sound.add('flagSound');
            thudSound = this.sound.add('thudSound');
            fallSound = this.sound.add('fallSound');
            punchSound = this.sound.add('punchSound');

            

            // castle roof
            platforms.create(120, 100, 'ground')
                .setScale(1.25)
                .setOrigin(-0.35, 0)
                .refreshBody();


            player = this.physics.add.sprite(900, 600, 'dude');
            player.setScale(1);
            player.setBounce(0.35);
            player.setCollideWorldBounds(true);

            // bottom left knight
            knight1 = this.physics.add.sprite(350,600, 'knight-idle');
            knight1.setScale(0.3,0.3);
            knight1.setBounce(0.1);
            knight1.setName('knight1');
            knight1.setCollideWorldBounds(true);
            knight1.setData('attackingRight', false);
            knight1.setData('attackingLeft', false);


            knight2 = this.physics.add.sprite(650, 100, 'knight-idle');
            knight2.setScale(0.3,0.3);
            knight2.setBounce(0.1);
            knight2.setName('knight2');
            knight2.setCollideWorldBounds(true);
            knight2.setData('attackingRight', false);
            knight2.setData('attackingLeft', false);

            knight3 = this.physics.add.sprite(610,100, 'knight-idle');
            knight3.setScale(0.3,0.3);
            knight3.setName('knight3');
            knight3.setCollideWorldBounds(true);

           this.testGroup = this.physics.add.group({
                immovable: true,
                allowGravity: false
            });

            particles = this.add.particles('flares');


            // this.input.on('pointerdown', pointer => {

            //     emitter.explode(16);

            // });


            // send a knight for a random walk
            // Set up a timer to emit particles with a delay
            this.time.addEvent({
                delay: 5000, // Delay in milliseconds (adjust as needed)
                repeat: -1, // Repeat indefinitely or adjust as needed
                callback: function () {
                    // Randomly pick between 1 and another value (let's say 2)
                    var randomValue = Math.random() < 0.5 ? 1 : 2;

                    // Use an if statement
                    if (randomValue === 1) {
                        // Do something for the case when randomValue is 1
                        knight1.setVelocityX(-65);
                    } else {
                        // Do something for the case when randomValue is 2
                        knight1.setVelocityX(65);
                    }

                },
                callbackScope: this
            });


            const emitter = this.add.particles(400, 250, 'flares', {
                frame: [ 'red', 'yellow', 'green' ],
                lifespan: 580,
                speed: { min: -200, max: 90 },
                scale: { start: 0.2, end: 0 },
                gravityY: 150,
                blendMode: 'ADD',
                emitting: false
            });

            console.log('emitter', emitter);
            this.testGroup.add(this.physics.add.sprite(230, 105, 'flag').setScale(0.08).setDepth(0).setAngle(-20), true);

            cursors = this.input.keyboard.addKeys(
                {
                    up: Phaser.Input.Keyboard.KeyCodes.W,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.A,
                    right: Phaser.Input.Keyboard.KeyCodes.D
                });

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 2 }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: 'turn',
                frames: [{ key: 'dude', frame: 2 }],
                frameRate: 20
            });

            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('dude', { start: 3, end: 5 }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: 'left-king',
                frames: this.anims.generateFrameNumbers('dude-with-king', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: 'turn-king',
                frames: [{ key: 'dude-with-king', frame: 2 }],
                frameRate: 20
            });

            this.anims.create({
                key: 'right-king',
                frames: this.anims.generateFrameNumbers('dude-with-king', { start: 4, end: 7 }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: 'wash-cycle-anim',
                frames: this.anims.generateFrameNumbers('wash-cycle', { start: 0, end: 3 }),
                frameRate: 30,
                repeat: -1
            });

            this.anims.create({
                key: 'knight-idle',
                frames: this.anims.generateFrameNumbers('knight-idle', { start: 0, end: 3 }),
                frameRate: 15,
                repeat: -1
            });
            this.anims.create({
                key: 'knight-walk-right',
                frames: this.anims.generateFrameNumbers('knight-walk', { start: 0, end: 3 }),
                frameRate: 15,
                repeat: -1
            });

            this.anims.create({
                key: 'knight-walk-left',
                frames: this.anims.generateFrameNumbers('knight-walk', { start: 4, end: 7 }),
                frameRate: 15,
                repeat: -1
            });

            this.anims.create({
                key: 'knight-punch-left',
                frames: this.anims.generateFrameNumbers('knight-punch', { start: 0, end: 13 }),
                frameRate: 35,
                repeat: 1
            });

            this.anims.create({
                key: 'knight-punch-right',
                frames: this.anims.generateFrameNumbers('knight-punch', { start: 14, end: 27 }),
                frameRate:35,
                repeat: 1
            });
            
            scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

            this.physics.add.collider(player, platforms);

            // when we are not the king we should work out
            // if we bopped them on the top of their bounding box
            // and if we didn't then we lose a life
            this.physics.add.collider(knight1, player, function(obj1, obj2){
                // have we collected the flag? (if so this doesnt matter)
                if (!didCollectFlag && obj1.name === 'knight1') {

                    // check if bopped
                    // if not, we lose a life
                    if (obj1.body.touching.up) {

                        // boop
                        console.log('boop - on top!');
                        knight1.disableBody(true, true);

                    } else {

                        // lose a life (or score for now)
                        score -= 1000;
                        scoreText.setText('Score: ' + score);

                        knight1.setVelocityX(0);

                     
                        // i think i got these round the wrong way
                        if (obj1.body.touching.left) {
                            emitter.setPosition(obj1.body.position.x + obj1.body.halfWidth - knightParticleOffsetX,
                                            obj1.body.position.y + obj1.body.halfHeight + knightParticleOffsetY);
                        

                            knight1.setData('attackingRight', true);
                            
                        }

                        // i think i got these round the wrong way
                        if (obj1.body.touching.right) {

                            emitter.setPosition(obj1.body.position.x + obj1.body.halfWidth + knightParticleOffsetX,
                                            obj1.body.position.y + obj1.body.halfHeight + knightParticleOffsetY);
                        

                            knight1.setData('attackingLeft', true);
                        }

                       
                        if (!punchSound.isPlaying) {
                            punchSound.play();
                        }
                        
                        emitter.explode(7);
                        

                    }

                }
            });

            // when we are not the king we should work out
            // if we bopped them on the top of their bounding box
            // and if we didn't then we lose a life
            this.physics.add.collider(knight2, player, function(obj1, obj2){
                // have we collected the flag? (if so this doesnt matter)
                if (!didCollectFlag && obj1.name === 'knight2') {

                    // check if bopped
                    // if not, we lose a life
                    if (obj1.body.touching.up) {

                        // boop
                        console.log('boop - on top!');
                        knight2.disableBody(true, true);

                    } else {

                        // lose a life (or score for now)
                        score -= 1000;
                        scoreText.setText('Score: ' + score);

                        knight2.setVelocityX(0);

                     
                        // i think i got these round the wrong way
                        if (obj1.body.touching.left) {
                            emitter.setPosition(obj1.body.position.x + obj1.body.halfWidth - knightParticleOffsetX,
                                            obj1.body.position.y + obj1.body.halfHeight + knightParticleOffsetY);
                        

                            knight2.setData('attackingRight', true);
                            
                        }

                        // i think i got these round the wrong way
                        if (obj1.body.touching.right) {

                            emitter.setPosition(obj1.body.position.x + obj1.body.halfWidth + knightParticleOffsetX,
                                            obj1.body.position.y + obj1.body.halfHeight + knightParticleOffsetY);
                        

                            knight2.setData('attackingLeft', true);
                        }

                       
                        if (!punchSound.isPlaying) {
                            punchSound.play();
                        }
                        
                        emitter.explode(7);
                        

                    }

                }
            });

            


            // falling knight sequence
            this.physics.add.collider(knight3, platforms, function(obj1, obj2){
                if (!knight3didHitGround && obj2.name === 'ground') {
                    knight3didHitGround = true;
                }
            });



            this.physics.add.collider(knight1, platforms);
            this.physics.add.collider(knight2, platforms);


            this.physics.add.overlap(player, this.testGroup, function(a,b,collisionInfo){
                if (didCollectFlag){
                    // do nothing
                }else{
                    flagSound.play();

                    score += 1000;
                    scoreText.setText('Score: ' + score);

                    // in future remove the flag
                }

                didCollectFlag = true;
            }, null, this);



            
            // create the dead knight
            deadKnight3 = this.add.image(-100, -200, 'deadKnight').setScale(0.25,0.25);



            // 
            this.physics.add.collider(player, platforms);
            
           
            timerText = this.add.text(20, 40, 'aa', { fontSize: '32px', fill: '#000' });



            music = this.sound.add('piano');
            music.play();



            nextLevel = () => {

                if ((level + 1) == levels.length) {
                    // you win , let washer continue
                    scoreText.setText('Score: ' + score + ' - GAME OVER, YOU WIN');
                    gameOver = true; // should stop timer

                } else {

                    washStarted = false;
                    level++;

                    score += 1000;
                    scoreText.setText('Score: ' + score);

                    stars = this.physics.add.group({
                        key: 'star',
                        repeat: levels[level].repeat,
                        setXY: { x: 12, y: 0, stepX: 70 }
                    });

                    stars.children.iterate(function (child) {

                        child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

                    });


                    // pass existing platform (ground) into generator
                    generateAndAddPlatforms(platforms, level);

                    this.physics.add.collider(stars, platforms);
                    this.physics.add.overlap(player, stars, collectStar, null, this);

                }



            }


            knight1.setVelocityX(80);


            knight1.on(Phaser.Animations.Events.ANIMATION_COMPLETE_KEY + "knight-punch-right", function () {
                idleKnight1();
                console.log('knight1 finished punching R');
                punchSound.stop();
            }, this);
            knight1.on(Phaser.Animations.Events.ANIMATION_COMPLETE_KEY + "knight-punch-left", function () {
                idleKnight1();
                console.log('knight1 finished punching L');
                punchSound.stop();
            }, this);


            knight2.on(Phaser.Animations.Events.ANIMATION_COMPLETE_KEY + "knight-punch-right", function () {
                idleKnight2();
                console.log('knight2 finished punching R');
                punchSound.stop();
            }, this);
            knight2.on(Phaser.Animations.Events.ANIMATION_COMPLETE_KEY + "knight-punch-left", function () {
                idleKnight2();
                console.log('knight2 finished punching L');
                punchSound.stop();
            }, this);

        }

        // used to stop knight1 from attacking
        function idleKnight1(){
            knight1.setData('attackingRight', false);
            knight1.setData('attackingLeft', false);
            // stop the knight moving
            knight1.setVelocityX(0);
        }

        // used to stop knight2 from attacking
        function idleKnight2(){
            knight2.setData('attackingRight', false);
            knight2.setData('attackingLeft', false);
            // stop the knight moving
            knight2.setVelocityX(0);
        }

        function update(time, delta) {

            var starAnim = '';

            if (!gameOver) {
                timer += delta;
                timerText.setText('Time: ' + Math.round(timer / 1000, 2));
            }

            
            // this knight dies
            knight3.anims.play('knight-walk-right', true);

           
            if ( knight2.data.values.attackingRight  != true && knight2.data.values.attackingLeft  != true
              && knight2.body.velocity.x > 0) {
                // right
                knight2.anims.play('knight-walk-right', true);
            }
            if ( knight2.data.values.attackingRight  != true && knight2.data.values.attackingLeft  != true
                && knight2.body.velocity.x < 0) {
                // left
                knight2.anims.play('knight-walk-left', true);
            }
            if ( knight2.data.values.attackingRight  != true && knight2.data.values.attackingLeft  != true
                 && knight2.body.velocity.x == 0) {
                // idle
                knight2.anims.play('knight-idle', true);
            } else {
                if (knight2.data.values.attackingRight == true) {
                    knight2.anims.play('knight-punch-right', true);
                }
                if (knight2.data.values.attackingLeft == true) {
                    knight2.anims.play('knight-punch-left', true);
                }
            }
            
            if ( knight1.data.values.attackingRight  != true && knight1.data.values.attackingLeft  != true
              && knight1.body.velocity.x > 0) {
                // right
                knight1.anims.play('knight-walk-right', true);
            }
            if ( knight1.data.values.attackingRight  != true && knight1.data.values.attackingLeft  != true
                && knight1.body.velocity.x < 0) {
                // left
                knight1.anims.play('knight-walk-left', true);
            }
            if ( knight1.data.values.attackingRight  != true && knight1.data.values.attackingLeft  != true
                 && knight1.body.velocity.x == 0) {
                // idle
                knight1.anims.play('knight-idle', true);
            } else {
                if (knight1.data.values.attackingRight == true) {
                    knight1.anims.play('knight-punch-right', true);
                }
                if (knight1.data.values.attackingLeft == true) {
                    knight1.anims.play('knight-punch-left', true);
                }
            }
            



            // start walking straight away
            knight3.setVelocityX(45);

            if (timer > 3000 && knight3.body.touching.down==false)
            {
                knight3falling = true;

            }

            if (!didPlayKnight3FallingSound && knight3falling) {
                fallSound.play();
                didPlayKnight3FallingSound = true;
            }





            if (knight3didHitGround && !didPlayKnight3GroundSound) {
                thudSound.play();
                knight3.disableBody(true, true);

                // bring in our dead knight from offscreen
                //                      L&R, Up & down
                deadKnight3.setPosition(810, 680);


                didPlayKnight3GroundSound = true;
            }

            if (didCollectFlag > 0) {
                starAnim = '-king';
            }

            if (cursors.left.isDown) {
                player.setVelocityX(-160);

                player.anims.play('left' + starAnim, true);
            }
            else if (cursors.right.isDown) {
                player.setVelocityX(160);

                player.anims.play('right' + starAnim, true);
            }
            else {
                player.setVelocityX(0);

                player.anims.play('turn' + starAnim);
            }

            if (cursors.up.isDown && player.body.touching.down) {
                player.setVelocityY(-420);
            }



        }

        function collectStar(player, star) {
            star.disableBody(true, true);
            hasStars++;

            score += 10;
            scoreText.setText('Score: ' + score);
        }

        function dropStarStartWash(player, wm) {


            if (!washStarted && hasStars > 0 && stars.countActive(true) === 0) {
                hasStars = 0;
                washStarted = true;

                score += 100;
                scoreText.setText('Score: ' + score);

                wm.anims.play('wash-cycle-anim', true);

                setTimeout(function () {
                    wm.anims.stop();
                    nextLevel();
                }, 2200);

            }

        }


        function punch(char1, char2) {
            // char 1 punches char 2

        }

        function generateAndAddPlatforms(platforms, complexityLevel) {


            // some sensible constraints
            // if you have platforms high than this
            // then you need a platform AT this height to jump FROM
            const minPlatform = [600, 400];
            const extremeTopLeftPlatform = [0, 90];
            const extremeTopLeftPlatformJumpBox = [180, 190];
            const topLeftPlatform = [50, 250];

            switch (complexityLevel) {
                case 0:
                    // top left
                    platforms.create(topLeftPlatform[0], topLeftPlatform[1], 'ground');

                    break;
                case 1:
                    // top right
                    platforms.create(750, 220, 'ground');
                    // assume player dropped to the machine to be at this point so 
                    // give them a leg back up
                    platforms.create(minPlatform[0], minPlatform[1], 'ground');
                    break;
                case 2:
                    break;
                case 3:
                    platforms.create(600, 400, 'ground');
                    platforms.create(750, 220, 'ground').setScale(0.2).refreshBody();
                    break;
                case 4:
                    // x top left
                    platforms.create(extremeTopLeftPlatform[0], extremeTopLeftPlatform[1], 'platform2').setScale(0.2).refreshBody();
                    platforms.create(extremeTopLeftPlatformJumpBox[0], extremeTopLeftPlatformJumpBox[1], 'ground').setScale(0.2).refreshBody();
                    break;
                default:
                    console.error('How did we end up like this?');
            }

        }

    </script>

</body>

</html>